---
title: "R Notebook"
output: html_notebook
---

```{r}
library(conflicted)
library(raster)
library(tidyverse)
library(sf)
library(lubridate)
library(spatialEco)
library(ambient)
library(ggnewscale)
library(patchwork)
conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")

R.files = list.files("../R", full.names = T)
for (f in R.files) source(f)
set.seed(1)
```

# Initialisation

```{r}
env_length = 100
n_locations = 100
n_humans = 200
locations = tibble(
  X = runif(n_locations, min=0, max=env_length),
  Y = runif(n_locations, min=0, max=env_length)
)
humans = tibble(
  ID = seq_len(n_humans),
  infected = runif(n_humans) < 0.1,
  t_infection = ifelse(infected, 0, NA),
  blood_gametocyte_prob = 0,
  location_ix = replicate(n_humans, unique(sample(seq_len(n_locations), 3, T)), simplify=F),
  location_proportions = lapply(location_ix, function(x) {
    unnormed = sort(runif(length(x)), decreasing = TRUE)
    unnormed / sum(unnormed)
  })
)
mosquito_raster = make_perlin_mosquitoes(c(env_length, env_length))
mosquito_raster[][mosquito_raster[] < 3000] = 0
mysim = Simulation$new(humans = humans,
                       locations = locations,
                       mosquito_raster = mosquito_raster,
                       max_human_infectivity = 60,
                       bite_rate = 0.1,
                       mosquito_death_rate = 0.25)
mysim$plot_mosquito_infectivity()
mysim$plot_human_infectivity()
mysim$plot_mosquito_migration()
mysim$plot_init()
```

Time step

```{r}
n_iter = 40
pb = txtProgressBar(min = 0, max = n_iter, style = 3)
tictoc::tic(paste("Processing", n_iter, "iterations"))
for (t in seq_len(n_iter))  {
  setTxtProgressBar(pb, t)
  mysim$iterate(1)
}
tictoc::toc()

mysim$plot()
```


